#!/usr/bin/python

import os, sys, hashlib, shutil

def remove(dir):
    for dirnames, dirpath, filenames in os.walk(dir):
        for i in range(0, len(filenames)):
            fileName = filenames[i]
            try:
                os.remove(os.path.join(dir, fileName))
            except Exception as e:
                print "remove():Error removing %s : %s" % fileName, str(e)
        try:
            os.rmdir(dir)
        except Exception as e:
            print "remove(): directory removal problem %s : %s" % dir, str(e)


def copy(dirSrc, dirDest):
    for dirnames, dirpath, filenames in os.walk(dirSrc):
        try:
            for i in range(0, len(filenames)):
                fileName = filenames[i]
                fin = open(os.path.join(dirSrc, fileName), 'rb')
                dataHash = sha256(fin.read(7500))
                fin.close()
                try:
                    if not os.path.exists(os.path.join(dirDest, fileName)):
                        shutil.copy(os.path.join(dirSrc, fileName), os.path.join(dirDest, fileName))
                        # sys.exit(1)
                except Exception as e:
                    print "copy():Error copying %s: %s" % (fileName, str(e))
        except Exception as e:
            print "copy():Error traversing src directory %s : %s" % dirSrc, str(e)


def sha256(data):
    fileHash = hashlib.sha256(data).hexdigest()
    return fileHash

def searchAndCollect(src):
    cnt = 0
    os.mkdir("./Test")
    dest = "./Test"

    print "Searching %s for .exe's, saving to %s" % (src, dest)
    for dirpath, dirnames, filenames in os.walk(src):
    	if src in dirnames:
    	    print "Skipping target directory."
    	    continue
        try:
	    for i in range(0, len(filenames)):
		    fileName = filenames[i]
		    fin = open(os.path.join(dirpath, fileName), 'rb')
            data = fin.read(2)
            fileSize = os.stat(os.path.join(dirpath, fileName)).st_size
            if fileSize < 150000000 and data == 'MZ' or data == 'ZM':
             fin.seek(0,0)
             data = fin.read(7500)
             datahash = sha256(data)
             fin.close()
             try:
                if not os.path.exists(os.path.join(dest, datahash)):
                    cnt = cnt + 1
                    shutil.copy( os.path.join(dirpath, fileName), os.path.join(dest, datahash))
                    return
             except Exception as e:
			    print "Error copying %s: %s" % (fileName, str(e))
	except Exception as e:
	    print "Error reading %s: %s" % (fileName, str(e))
    print cnt


if __name__ == '__main__':
    searchAndCollect('D:\\')
    copy('.\Test', '.\Benignware')
    remove('.\Test')
    searchAndCollect('C:\\')
    copy('.\Test', '.\Benignware')
    remove('.\Test')
    print "End"
